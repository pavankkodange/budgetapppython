<!DOCTYPE html>
<html>

<head>
    <title>Google Drive Authorization</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .container {
            text-align: center;
            padding: 2rem;
        }

        .success {
            font-size: 48px;
            margin-bottom: 1rem;
        }

        .message {
            font-size: 20px;
            font-weight: 500;
        }

        .submessage {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="success">⏳</div>
        <div class="message">Processing authorization...</div>
        <div class="submessage">Please wait...</div>
    </div>

    <script>
        // Check if mobile device
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        function showSuccess() {
            document.querySelector('.success').textContent = '✅';
            document.querySelector('.message').textContent = 'Authorization successful!';
            document.querySelector('.submessage').textContent = isMobile ? 'Redirecting to app...' : 'You can close this window...';
        }

        function showError(msg) {
            document.querySelector('.success').textContent = '❌';
            document.querySelector('.message').textContent = 'Authorization failed';
            document.querySelector('.submessage').textContent = msg || 'Please try again';
        }

        // Extract access token from URL hash
        const fragment = window.location.hash;

        if (fragment.startsWith('#')) {
            const params = new URLSearchParams(fragment.substring(1));
            const accessToken = params.get('access_token');
            const error = params.get('error');

            if (error) {
                showError('Authorization failed: ' + error);

                // If mobile, redirect to app with error
                if (isMobile) {
                    setTimeout(() => {
                        window.location.href = 'com.trackmyfunds.app://drive-callback?error=' + encodeURIComponent(error);
                    }, 2000);
                }
            } else if (accessToken) {
                showSuccess();

                // For mobile: redirect to deep link with token as query parameter
                if (isMobile) {
                    console.log('Mobile detected - redirecting to deep link with token');
                    setTimeout(() => {
                        window.location.href = 'com.trackmyfunds.app://drive-callback?token=' + encodeURIComponent(accessToken);
                    }, 1000);
                }
                // For web: use postMessage (popup to parent)
                else if (window.opener) {
                    window.opener.postMessage({
                        type: 'DRIVE_AUTH_SUCCESS',
                        token: accessToken
                    }, window.location.origin);

                    setTimeout(() => {
                        window.close();
                    }, 1000);
                } else {
                    showError('Authorization window error. Please try again.');
                }
            }
        } else {
            showError('No authorization data received.');
        }
    </script>
</body>

</html>